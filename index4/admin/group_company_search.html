<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>報帳系統__管理員</title>   	
 
  <meta http-equiv="cache-control" content="no-cache">  
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta name="format-detection" content="telephone=no">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<link rel="icon" href="https://tafengtravel.github.io/tafengtravel/index1/tafenglogo6.ico" type="image/x-icon" />
<link rel="shortcut icon" href="https://tafengtravel.github.io/tafengtravel/index1/tafenglogo6.ico" type="image/x-icon" />

<link href='https://tafengtravel.github.io/tafengtravel/index/sm-css/sm-core-css.css' rel='stylesheet' type='text/css' />
<!-- "sm-blue" menu theme (optional, you can use your own CSS, too) -->
<link href='https://tafengtravel.github.io/tafengtravel/index/sm-css/sm-mint/sm-mint.css' rel='stylesheet' type='text/css' />
<link href='smart.css' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

<style type="text/css" media="print">
  @page { 
      size: landscape;
  }

</style>


<link rel='stylesheet' href='table.css' type='text/css'>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script type="text/javascript" src="jquery.smartmenus.js"></script>

</head>

<body>

       <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="/__/firebase/7.14.3/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

<!-- Initialize Firebase -->
<script src="/__/firebase/init.js"></script>
   
   <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>

<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-firestore.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<nav class="main-nav" role="navigation">

  <!-- Mobile menu toggle button (hamburger/x icon) -->
  <input id="main-menu-state" type="checkbox" />
  <label class="main-menu-btn" for="main-menu-state">
    <span class="main-menu-btn-icon"></span> Toggle main menu visibility
  </label>

  <h2 class="nav-brand"><span class="title" >報帳系統__管理員</span></h2>

  <!-- Sample menu definition -->
  <ul id="main-menu" class="sm sm-mint">
    <li><a href="home.html">首頁</a></li>
    <li><a href="#">修改報帳</a>
      <ul>
        <li><a href="fit_modify.html">散客</a></li>
        <li><a href="group_modify.html">團體</a></li>
      </ul>
    </li>
    <li><a href="#">表單</a>
      <ul>
        <li><a href="fit_table.html">散客</a></li>
        <li><a href="group_table.html">團體</a></li>
      </ul>
    </li>
    <li><a href="#">廠商搜尋</a>
      <ul>
        <li><a href="fit_company_search.html">散客</a></li>
        <li><a href="group_company_search.html">團體</a></li>
      </ul>
    </li>
    <li><a href="income.html">當日收入</a></li>
    <li><a href="today_table.html">當日業績</a></li>
    <li><a href="year_table.html">年度報表</a></li>    
  </ul>
</nav>


<span class="status" >
  <input type="text" id="mail" disabled="disabled" class="lable2" style="background-color: transparent; border:none; text-align: center; font-family:Microsoft JhengHei;font-weight:bold; ">
</span>

<div class="w3-row">
  <div class="w3-col s12 m12 l4 ">
  <span class="lable2" ><label>搜尋月份：</label></span><input class="lable2" type="date" id="depdate" >
  </div>
  <div class="w3-col s12 m12 l8 ">
  <span class="lable2" ><label>搜尋廠商：</label></span>  
  <input class="lable2" type="text" id="name">
  
  <span class="lable2" ><label>排序：</label></span>  
    <select class="lable2" id="orderby" >
      <option value="團號">團號</option><option value="出發日期">出發日期</option>
    </select>
  &emsp;<button onclick="search()" class="lable2" type="button"  >查詢</button>
  </div>
</div>

<div class="w3-responsive">
  <table id="myTable" class="w3-table-all" >
    <tr>
      <th nowrap>筆數</th><th nowrap>團號</th><th nowrap>客服</th>
      <th nowrap>出發日期&emsp;&emsp;</th><th nowrap>結束日期&emsp;&emsp;</th><th nowrap>團名&emsp;&emsp;</th><th nowrap>公司名稱&emsp;&emsp;</th>
      <th nowrap>代表人&emsp;&emsp;</th><th nowrap>廠商&emsp;&emsp;</th><th nowrap>品項&emsp;&emsp;</th><th nowrap>支出</th>
      <th nowrap>定金D/L&emsp;&emsp;</th><th nowrap>定金</th><th nowrap>尾款D/L&emsp;&emsp;</th><th nowrap>尾款</th>
    </tr>
  </table>
</div>  


<div class="w3-row">
  <div class="w3-col s12 m12 l3 ">
    <span class="lable2" ><label>總支出：</label></span>
    <input type="text" id="total_pay" disabled="disabled" class="lable2" style="background-color: transparent; border:none; text-align: center; font-family:Microsoft JhengHei;font-weight:bold;width:200px">
  </div>
  <div class="w3-col s12 m12 l3 ">
    <span class="lable2" ><label>總定金：</label></span>
    <input type="text" id="total_downpay" disabled="disabled" class="lable2" style="background-color: transparent; border:none; text-align: center; font-family:Microsoft JhengHei;font-weight:bold;width:200px">
  </div>
  <div class="w3-col s12 m12 l3 ">
    <span class="lable2" ><label>總尾款：</label></span>
    <input type="text" id="total_lastpay" disabled="disabled" class="lable2" style="background-color: transparent; border:none; text-align: center; font-family:Microsoft JhengHei;font-weight:bold;width:200px">
  </div>
</div>


 <script src="secure.js" async></script>

<script>

let number;
let del;

function info(){
    
}

function clear1(){
  window.location.reload("");
}

 

async function search(){
  var orderby = document.getElementById("orderby").value;
  var depdate = document.getElementById("depdate").value;  
  var name = document.getElementById("name").value;  
  if(depdate == ""){
    alert('請選取月份');
    window.location.reload("");
  }else{
  }

  if(name == ""){
    alert('請輸入廠商');
    window.location.reload("");
  }else{
  }

    
  var db = firebase.firestore();

  var ref = db.collection(depdate.substring(0,4)+'-'+depdate.substring(5,7)+'G');
  var cell = [];  
  var table = document.getElementById("myTable");
  var row;
  var j=1;
  var data1 =[];
  var k=0;
  let payment=0;
  let downpayment=0;
  let lastpayment=0;
  let a=1;

  let total_pay=0;
  let total_downpay=0;
  let total_lastpay=0;

//判斷是否為0即刪除
  if(del==0){
    number=1;
  }
  del = 0;

  for(q=1;q<number;q++){
    table.deleteRow(1);

  }
//------------


   for(i=1;i<16;i++){
    await ref.where('第'+i+'筆支出廠商','==',name).get().then(querySnapshot => {
    querySnapshot.forEach(doc => {      

          data1[k] = doc.data();
          data1[k]={...data1[k],項目:i};
          k=k+1;
          a=a+1;
          number=a;
          del=1;
    });
  });
  
  }

  console.log(data1[0].出發日期);


  if(orderby == '團號'){
    data1.sort((a, b) => (a.團號).localeCompare(b.團號));
  }else if(orderby == '出發日期'){
    data1.sort((a, b) => (a.出發日期).localeCompare(b.出發日期));
  }


  for(i=0;i<data1.length;i++){

    k = data1[i].項目;

    payment = data1[i]['第'+k+'筆支出'];
    downpayment= data1[i]['第'+k+'筆op定金'];
    lastpayment= data1[i]['第'+k+'筆op尾款'];

    payment = parseFloat(payment);
    downpayment = parseFloat(downpayment);
    lastpayment = parseFloat(lastpayment);

    if (isNaN(downpayment)) {
      downpayment=0;
    }
    if (isNaN(payment)) {
      payment=0;
    }
    if (isNaN(lastpayment)) {
      lastpayment=0;
    }

    total_pay = total_pay + payment;
    total_downpay = total_downpay + downpayment;

    row = table.insertRow(j);
    cell[0] = row.insertCell(0);
    cell[0].innerHTML=j;
    cell[1] = row.insertCell(1);
    cell[1].innerHTML=data1[i].團號;
    cell[2] = row.insertCell(2);
    cell[2].innerHTML=data1[i].客服;
    cell[3] = row.insertCell(3);
    cell[3].innerHTML=data1[i].出發日期;
    cell[4] = row.insertCell(4);
    cell[4].innerHTML=data1[i].結束日期;
    cell[5] = row.insertCell(5);
    cell[5].innerHTML=data1[i].團名;
    cell[6] = row.insertCell(6);
    cell[6].innerHTML=data1[i].公司名稱;
    cell[7] = row.insertCell(7);
    cell[7].innerHTML=data1[i].代表人;
    cell[8] = row.insertCell(8);
    cell[8].innerHTML=data1[i]['第'+k+'筆支出廠商'];
    cell[9] = row.insertCell(9);
    cell[9].innerHTML=data1[i]['第'+k+'筆支出品項'];
    cell[10] = row.insertCell(10);
    cell[10].innerHTML=data1[i]['第'+k+'筆支出'];
    cell[11] = row.insertCell(11);
    cell[11].innerHTML=data1[i]['第'+k+'筆定金DL'];
    cell[12] = row.insertCell(12);
    cell[12].innerHTML=data1[i]['第'+k+'筆op定金'];
    cell[13] = row.insertCell(13);
    cell[13].innerHTML=data1[i]['第'+k+'筆尾款DL'];
    cell[14] = row.insertCell(14);
    cell[14].innerHTML=data1[i]['第'+k+'筆op尾款'];

    j=j+1;

    cell[1].addEventListener("click", function(e){
      console.log(e.target.innerText);

      let modify = window.open('group_modify.html');

      localStorage.setItem("oldnumber", e.target.innerText);
      localStorage.setItem("depdate", depdate);
    
    });
    
  }

total_lastpay = total_pay - total_downpay; 

document.getElementById("total_pay").value = total_pay;
document.getElementById("total_downpay").value = total_downpay;
document.getElementById("total_lastpay").value = total_lastpay;

}


</script>

</body>
</html>