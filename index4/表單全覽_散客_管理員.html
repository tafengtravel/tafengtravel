<!DOCTYPE html>
<html>
<head>
<!-- SmartMenus core CSS (required) -->
<link href='https://tafengtravel.github.io/tafengtravel/index/sm-css/sm-core-css.css' rel='stylesheet' type='text/css' />
<!-- "sm-blue" menu theme (optional, you can use your own CSS, too) -->
<link href='https://tafengtravel.github.io/tafengtravel/index/sm-css/sm-mint/sm-mint.css' rel='stylesheet' type='text/css' />

<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.0.0-beta.3/assets/owl.carousel.min.css'>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.0.0-beta.3/assets/owl.theme.default.min.css'><link rel="stylesheet" href="./style.css">

<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel='stylesheet' href='table.css'>
<style>

.table {
    font-size: 22px;
  }
  
  @media(max-width:768px) {
  .table {
      font-size: 10px;
    }
  }
  
  .table2 {
    font-size: 48px;
    border-left:20px #FF6600 solid
  }
  
  @media(max-width:768px) {
  .table2 {
      font-size: 24px;
      border-left:15px #FF6600 solid
    }
  }
  
  
  .hide-in-phone{display:none} 
  @media only screen and (min-width:576px) { .hide-in-phone { display: block; } }
  
  .hide-in-com{display:none} 
  @media only screen and (max-width:576px) { .hide-in-com { display: block; } }
  
  
  
  .main-nav {
    border-bottom: 2px solid #FF6600;
    background: #fff;
  }
  
  .main-nav:after {
    clear: both;
    content: "\00a0";
    display: block;
    height: 0;
    font: 0px/0 serif;
    overflow: hidden;
  }
  
  .nav-brand {
    float: left;
    margin: 0;
  }
  
  .nav-brand a {
    display: block;
    padding: 11px 11px 11px 20px;
    color: #333;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 22px;
    font-weight: normal;
    line-height: 17px;
    text-decoration: none;
  }
  
  #main-menu {
    clear: both;
    border-bottom: 0;
  }
  
  @media (min-width: 768px) {
    #main-menu {
      float: right;
      clear: none;
    }
  }
  
  
  /* Mobile menu toggle button */
  
  .main-menu-btn {
    float: right;
    margin: 5px 10px;
    position: relative;
    display: inline-block;
    width: 29px;
    height: 29px;
    text-indent: 29px;
    white-space: nowrap;
    overflow: hidden;
    cursor: pointer;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }
  
  
  /* hamburger icon */
  
  .main-menu-btn-icon,
  .main-menu-btn-icon:before,
  .main-menu-btn-icon:after {
    position: absolute;
    top: 50%;
    left: 2px;
    height: 2px;
    width: 24px;
    background: #333;
    -webkit-transition: all 0.25s;
    transition: all 0.25s;
  }
  
  .main-menu-btn-icon:before {
    content: '';
    top: -7px;
    left: 0;
  }
  
  .main-menu-btn-icon:after {
    content: '';
    top: 7px;
    left: 0;
  }
  
  
  /* x icon */
  
  #main-menu-state:checked ~ .main-menu-btn .main-menu-btn-icon {
    height: 0;
    background: transparent;
  }
  
  #main-menu-state:checked ~ .main-menu-btn .main-menu-btn-icon:before {
    top: 0;
    -webkit-transform: rotate(-45deg);
    transform: rotate(-45deg);
  }
  
  #main-menu-state:checked ~ .main-menu-btn .main-menu-btn-icon:after {
    top: 0;
    -webkit-transform: rotate(45deg);
    transform: rotate(45deg);
  }
  
  
  /* hide menu state checkbox (keep it visible to screen readers) */
  
  #main-menu-state {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    border: 0;
    padding: 0;
    overflow: hidden;
    clip: rect(1px, 1px, 1px, 1px);
  }
  
  
  /* hide the menu in mobile view */
  
  #main-menu-state:not(:checked) ~ #main-menu {
    display: none;
  }
  
  #main-menu-state:checked ~ #main-menu {
    display: block;
  }
  
  @media (min-width: 768px) {
    /* hide the button in desktop view */
    .main-menu-btn {
      position: absolute;
      top: -99999px;
    }
    /* always show the menu in desktop view */
    #main-menu-state:not(:checked) ~ #main-menu {
      display: block;
    }
  }
  
  
  /* IGNORE: Unrelated generic demo styles */
  
  body {
    margin: 8px;
    background: #fff;
    color: #000000;
    font: 18px/1.5em 'Helvetica Neue',Microsoft JhengHei;;
  }
  
  .demo-text {
    margin: 3em 22px;
  }
  
  .demo-text p {
    margin-bottom: 1em;
  }
  
  .demo-text a {
    color: #999;
  }
  
  


</style>

<script type="text/javascript">

  $(function() {
    $('#main-menu').smartmenus({
      subMenusSubOffsetX: 6,
      subMenusSubOffsetY: -8
    });
  });
  
  // SmartMenus mobile menu toggle button
  $(function() {
    var $mainMenuState = $('#main-menu-state');
    if ($mainMenuState.length) {
      // animate mobile menu
      $mainMenuState.change(function(e) {
        var $menu = $('#main-menu');
        if (this.checked) {
          $menu.hide().slideDown(250, function() { $menu.css('display', ''); });
        } else {
          $menu.show().slideUp(250, function() { $menu.css('display', ''); });
        }
      });
      // hide mobile menu beforeunload
      $(window).bind('beforeunload unload', function() {
        if ($mainMenuState[0].checked) {
          $mainMenuState[0].click();
        }
      });
    }
  });
  </script>  


</head>
<body>

       <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="/__/firebase/7.14.3/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

<!-- Initialize Firebase -->
<script src="/__/firebase/init.js"></script>
   
   <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>

<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-firestore.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>




<style>  

</style> 

<nav class="main-nav" role="navigation">

  <!-- Mobile menu toggle button (hamburger/x icon) -->
  <input id="main-menu-state" type="checkbox" />
  <label class="main-menu-btn" for="main-menu-state">
    <span class="main-menu-btn-icon"></span> 
  </label>

  <h2 class="nav-brand"><span class="title" >報帳系統__管理員</span></h2>

  <!-- Sample menu definition -->
  <ul id="main-menu" class="sm sm-mint">
    <li><a href="首頁_管理員.html">回到首頁</a></li>
    <li><a href="修改報帳_散客_管理員.html">修改報帳_散客</a>
    <li><a href="修改報帳_團體_管理員.html">修改報帳_團體</a></li>
    <li><a href="表單全覽_散客_管理員.html">表單全覽_散客</a>
	  <li><a href="表單全覽_團體_管理員.html">表單全覽_團體</a></li>
    <li><a href="年度報表_管理員.html">年度報表_總計</a></li>   
    <li><a href="當日業績_管理員.html">當日業績</a></li>
  </ul>
</nav>


<span class="status" >
  <input type="text" id="mail" disabled="disabled" style="font-size:20px ; background-color: transparent; border:none; text-align: center; font-family:Microsoft JhengHei;font-weight:bold;">
</span>


<div class="w3-row">
  <div class="w3-col s12 m4 l2 "lable2>
    <span class="lable2" ><label>搜尋月份：</label></span>
    <input type="date" id="depdate" style="font-size:20px">
  </div>
  <div class="w3-col s6 m4 l1 ">
    <span class="lable2" ><label>客服：</label></span>  

    <select id="cs" style="font-size:20px">
      <option value="all">全部</option><option value="A1">A1</option><option value="A2">A2</option><option value="A3">A3</option><option value="A4">A4</option>
      <option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option><option value="B4">B4</option>
      <option value="B5">B5</option><option value="B6">B6</option><option value="B7">B7</option><option value="B8">B8</option>
      <option value="B9">B9</option><option value="B10">B10</option><option value="B11">B11</option><option value="B12">B12</option>
    </select>
  </div>
  <div class="w3-col s6 m4 l2">
    <span class="lable2" ><label>排序：</label></span>  
    <select id="orderby" style="font-size:20px">
      <option value="團號">團號</option><option value="出發日期">出發日期</option>
    </select>
    <button onclick="search()" id ="search"  type="button" style="font-size:20px"  >查詢</button>
  </div>

  <div class="w3-col m4 l2 ">
    <span class="lable2" ><label>營業額：</label></span>
    <input type="text" id="revenue" style="font-size:20px ;width:100px; background-color: transparent; border:none; text-align: left; font-family:Microsoft JhengHei;font-weight:bold;">
  </div>
  <div class="w3-col m4 l2 ">
    <span class="lable2" ><label>總利潤：</label></span>
    <input type="text" id="totalprofit" style="font-size:20px ;width:100px; background-color: transparent; border:none; text-align: left; font-family:Microsoft JhengHei;font-weight:bold;">
  </div>
  <div class="w3-col m4 l2 ">
    <span class="lable2" ><label>總人數：</label></span>
    <input type="text" id="totalpeople" style="font-size:20px ;width:100px; background-color: transparent; border:none; text-align: left; font-family:Microsoft JhengHei;font-weight:bold;">
  </div>
</div>


<div class="w3-responsive">
  <table id="myTable" class="w3-table-all w3-large" >
  <tr>
    <th class="text-nowrap">筆數</th><th class="text-nowrap">團號</th><th class="text-nowrap"><font color="red">團體</font>
    </th><th class="text-nowrap">客服</th><th class="text-nowrap">出發日期&emsp;&emsp;</th>
    <th class="text-nowrap">結束日期&emsp;&emsp;</th><th class="text-nowrap">團名&emsp;&emsp;</th><th class="text-nowrap">代表人&emsp;&emsp;</th>
    <th class="text-nowrap">人數</th><th class="text-nowrap">聯絡電話</th><th class="text-nowrap">利潤</th><th class="text-nowrap">主管核實</th><th class="text-nowrap">備註&emsp;&emsp;&emsp;&emsp;</th><th class="text-nowrap">地點&emsp;</th>
  </tr>
 </table>
</div>






 <script src="secure.js" async></script>

<script>  

let number;
let del;

function info(){
    
}


function clear1(){
  
  window.location.reload("");
}


async function search(){  

  var db = firebase.firestore();
  var depdate = document.getElementById("depdate").value; 
  var cs = document.getElementById("cs").value;
  var orderby = document.getElementById("orderby").value;
  var table = document.getElementById("myTable");

  if(depdate == ""){
    alert('請選取月份');
    window.location.reload("");
  }else{
  }

  
//判斷是否為0即刪除
  if(del==0){
    number=1;
  }
  del = 0;
  console.log(number);
  for(j=1;j<number;j++){
    table.deleteRow(1);

  }
//------------


  if(cs == 'all'){
  var ref = db.collection(depdate.substring(0,4)+'-'+depdate.substring(5,7));
  var id1=[];
  var data1=[];
  var j =0;
  var cell = [];
  var i=1;

  var row;
  var check;let check1;
  var totalprofit = 0;
  var profit = 0;
  var people = 0;
  var totalpeople = 0;
  let tax = 0;
  let revenue = 0;
  let price = 0;

  await ref.orderBy(orderby, 'asc').get().then(querySnapshot => {
    querySnapshot.forEach(doc => {       

      profit = parseInt(doc.data().利潤);
      people = parseInt(doc.data().人數);
      tax = parseInt(doc.data().稅金);

      price = parseInt(doc.data().團費);
      revenue = price+revenue;

      if (isNaN(tax)){
        tax=0;
      }
      profit = profit+tax;

      totalprofit = parseInt(totalprofit);
      totalpeople = parseInt(totalpeople);

      if(profit>10000){
        check = "●";
      }else{
        check = "";
      }

      if(doc.data().martina核實 == 'True'){
        check1="●";
      }else if(doc.data().martina核實 == 'False'){
        check1="";
      }

      row = table.insertRow(i);
      cell[0] = row.insertCell(0);
      cell[0].innerHTML=i;
      cell[1] = row.insertCell(1);
      cell[1].innerHTML=doc.id;
      cell[2] = row.insertCell(2);
      cell[2].innerHTML=check;
      cell[3] = row.insertCell(3);
      cell[3].innerHTML=doc.data().客服;
      cell[4] = row.insertCell(4);
      cell[4].innerHTML=doc.data().出發日期;
      cell[5] = row.insertCell(5);
      cell[5].innerHTML=doc.data().結束日期;
      cell[6] = row.insertCell(6);
      cell[6].innerHTML=doc.data().團名;
      cell[7] = row.insertCell(7);
      cell[7].innerHTML=doc.data().代表人;
      cell[8] = row.insertCell(8);
      cell[8].innerHTML=doc.data().人數;
      cell[9] = row.insertCell(9);
      cell[9].innerHTML=doc.data().聯絡電話;
      cell[10] = row.insertCell(10);
      cell[10].innerHTML=doc.data().利潤;
      cell[11] = row.insertCell(11);
      cell[11].innerHTML=check1;
      cell[12] = row.insertCell(12);
      cell[12].innerHTML=doc.data().其他項備註;
      cell[13] = row.insertCell(13);
      cell[13].innerHTML=doc.data().地點;
      i=i+1;
      totalprofit = totalprofit + profit ;
      totalpeople = totalpeople+ people ;

      console.log(i)

      number=i;
      del=1;

    });
  });
  document.getElementById("totalprofit").value =totalprofit;
  document.getElementById("totalpeople").value =totalpeople;
  document.getElementById("revenue").value =revenue;

  }else{
  var ref = db.collection(depdate.substring(0,4)+'-'+depdate.substring(5,7));
  var id1=[];
  var data1=[];
  var j =0;
  var cell = [];
  var i=1;

  var row;
  var check;let check1;
  var totalprofit = 0;
  var totalpeople = 0;
  var profit = 0;
  let tax = 0;
  let revenue = 0;

  await ref.orderBy(orderby, 'asc').where('客服','==',cs).get().then(querySnapshot => {
    querySnapshot.forEach(doc => {    
      profit = parseInt(doc.data().利潤);
      people = parseInt(doc.data().人數);
      tax = parseInt(doc.data().稅金);
      
      price = parseInt(doc.data().團費);
      revenue = price+revenue;

      if (isNaN(tax)){
        tax=0;
      }

      profit = profit+tax;
      
      totalprofit = parseInt(totalprofit);
      totalpeople = parseInt(totalpeople);

      

      if(profit>10000){
        check = "●";
      }else{
        check = "";
      }

      if(doc.data().martina核實 == 'True'){
        check1="●";
      }else if(doc.data().martina核實 == 'False'){
        check1="";
      }

      row = table.insertRow(i);
      cell[0] = row.insertCell(0);
      cell[0].innerHTML=i;
      cell[1] = row.insertCell(1);
      cell[1].innerHTML=doc.id;
      cell[2] = row.insertCell(2);
      cell[2].innerHTML=check;
      cell[3] = row.insertCell(3);
      cell[3].innerHTML=doc.data().客服;
      cell[4] = row.insertCell(4);
      cell[4].innerHTML=doc.data().出發日期;
      cell[5] = row.insertCell(5);
      cell[5].innerHTML=doc.data().結束日期;
      cell[6] = row.insertCell(6);
      cell[6].innerHTML=doc.data().團名;
      cell[7] = row.insertCell(7);
      cell[7].innerHTML=doc.data().代表人;
      cell[8] = row.insertCell(8);
      cell[8].innerHTML=doc.data().人數;
      cell[9] = row.insertCell(9);
      cell[9].innerHTML=doc.data().聯絡電話;
      cell[10] = row.insertCell(10);
      cell[10].innerHTML=doc.data().利潤;
      cell[11] = row.insertCell(11);
      cell[11].innerHTML=check1;
      cell[12] = row.insertCell(12);
      cell[12].innerHTML=doc.data().其他項備註;
      i=i+1;
      totalprofit = totalprofit + profit ;
      totalpeople = totalpeople+ people ;

      number=i;
      del=1;
      

    });
  });



  document.getElementById("totalprofit").value =totalprofit;
  document.getElementById("totalpeople").value =totalpeople;
  document.getElementById("revenue").value =revenue;
  } 

}


</script>

</body>
</html>
